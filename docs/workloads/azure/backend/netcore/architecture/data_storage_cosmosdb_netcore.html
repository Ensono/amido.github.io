<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-EKCQBC5CSJ","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EKCQBC5CSJ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EKCQBC5CSJ",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Amido Stacks " href="/opensearch.xml"><title data-react-helmet="true">Data Storage - CosmosDB | Amido Stacks </title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://stacks.amido.com/docs/workloads/azure/backend/netcore/architecture/data_storage_cosmosdb_netcore"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Data Storage - CosmosDB | Amido Stacks "><meta data-react-helmet="true" name="description" content=".NET Core REST API application - how to use the Stacks package for CosmosDB document storage"><meta data-react-helmet="true" property="og:description" content=".NET Core REST API application - how to use the Stacks package for CosmosDB document storage"><meta data-react-helmet="true" name="keywords" content=".net core,rest api,cqrs,template,cosmos,cosmosdb,data storage,azure,storage,configuration,cosmosdbkey,documentsearch,sql,api,repository,cosmosdb package,dependency injection,stacks"><link data-react-helmet="true" rel="shortcut icon" href="/img/thumbnail_stacks.png"><link data-react-helmet="true" rel="canonical" href="https://stacks.amido.com/docs/workloads/azure/backend/netcore/architecture/data_storage_cosmosdb_netcore"><link data-react-helmet="true" rel="alternate" href="https://stacks.amido.com/docs/workloads/azure/backend/netcore/architecture/data_storage_cosmosdb_netcore" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://stacks.amido.com/docs/workloads/azure/backend/netcore/architecture/data_storage_cosmosdb_netcore" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.f0d040b2.css">
<link rel="preload" href="/assets/js/runtime~main.0d297d5a.js" as="script">
<link rel="preload" href="/assets/js/main.156a79fa.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1boX">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_wide.svg" alt="Amido Stacks Logo" class="themedImage_3oOy themedImage--light_3ouy"><img src="/img/logo_wide.svg" alt="Amido Stacks Logo" class="themedImage_3oOy themedImage--dark_3zJb"></div><b class="navbar__title"></b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a href="https://github.com/amido/amido.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_2iFN toggle_2ySP toggleDisabled_1pbd"><div class="toggleTrack_1bVV" role="button" tabindex="-1"><div class="toggleTrackCheck_3GBG"><span class="toggleIcon_KBSf">üåú</span></div><div class="toggleTrackX_1jae"><span class="toggleIcon_KBSf">üåû</span></div><div class="toggleTrackThumb_2_QT"></div></div><input type="checkbox" class="toggleScreenReader_32DE" aria-label="Switch between dark and light mode"></div><div class="searchBox_xXbB"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_3zOJ"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_DkI0" type="button"></button><aside class="docSidebarContainer_G8MK"><div class="sidebar_1tWv"><nav class="menu thin-scrollbar menu_1Iah"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Learn about Stacks</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Workloads</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/workloads">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Azure</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Frontend Web Applications</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Backend Services</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Java Spring Boot REST API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">.NET Core</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/introduction_netcore">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/requirements_netcore">Requirements</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Quickstart</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Architecture</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/architecture/architecture_overview_netcore">Architecture Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/architecture/repository_overview_netcore">Repository Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/architecture/project_structure_netcore">Solution Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/workloads/azure/backend/netcore/architecture/data_storage_cosmosdb_netcore">Data Storage - CosmosDB</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/architecture/operations_events_exceptions_correlation_netcore">Operations, Events, Exceptions and Correlation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-6 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/architecture/nuget_dependencies">NuGet Dependencies</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-6 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Swagger Configuration</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/testing/functional_testing_netcore">Testing the API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/infrastructure_netcore">Infrastructure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/pipeline_netcore">Pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/logging_netcore">Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/workloads/azure/backend/netcore/security_netcore">Security</a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Google Cloud Platform</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Amazon Web Services</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Infrastructure</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Quality Assurance</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Stacks CLI</a></li></ul></nav></div></aside><main class="docMainContainer_3Zec"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col"><div class="docItemContainer_37q2"><article><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithStickyNavbar_1iPN" id="data-storage---cosmosdb">Data Storage - CosmosDB<a aria-hidden="true" class="hash-link" href="#data-storage---cosmosdb" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_1iPN" id="summary">Summary<a aria-hidden="true" class="hash-link" href="#summary" title="Direct link to heading">‚Äã</a></h3><p>This guide provides information on how to use the Stacks package for CosmosDB document storage.</p><p>The focus of this guide is the CosmosDB SQL API, it assumes the reader have prior knowledge about <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql-query-getting-started" target="_blank" rel="noopener noreferrer">CosmosDB SQL API</a> in order to understand the concepts describe thereafter.</p><p>It is out of scope for this document to explain what is CosmosDB and it&#x27;s respective storage models, but instead describe how the package for CosmosDB handles the communication with the server. If you don‚Äôt have enough understanding of CosmosDB concepts, please take some time to review the CosmosDB documentation before you continue.</p><br><h3 class="anchor anchorWithStickyNavbar_1iPN" id="introduction">Introduction<a aria-hidden="true" class="hash-link" href="#introduction" title="Direct link to heading">‚Äã</a></h3><p>Most applications requires a persistent data store to keep the application data safe and available for use whenever an operation is executed.</p><p>The main storage type used on this project is a document store to persist the domain data, the storage is provided by Azure Cosmos DB SQL API.</p><br><h3 class="anchor anchorWithStickyNavbar_1iPN" id="the-problem">The problem<a aria-hidden="true" class="hash-link" href="#the-problem" title="Direct link to heading">‚Äã</a></h3><p>Monolith applications generally use a single database to store all the application data, in general, monolith solutions contains a data layer responsible to handle the database communication and data conversion by using an ORM library like Entity Framework, NHibernate or Dapper.</p><p>Microservice architecture also requires a data layer, different from monolith applications, each microservice tend have it&#x27;s own data layer, generating lots of duplicate data access code spread across multiple repositories.</p><p>Duplicate data access code will at some point diverge and make each microservice have different features, or same features with different implementations that in most cases will be tightly coupled to the service that created it.</p><p>Most of these features created in a data access layer should be well planned, tested and made available to all services in order to have a consistent and reliable approach used by every team, reduce the time needed to implement data access logic and avoid the same pitfalls others might face when starting from scratch.</p><br><h3 class="anchor anchorWithStickyNavbar_1iPN" id="the-solution">The solution<a aria-hidden="true" class="hash-link" href="#the-solution" title="Direct link to heading">‚Äã</a></h3><p>Azure CosmosDB provides a reliable SDK to communicate with the CosmosDB server, but still require some knowledge from the developer to consume it properly, add proper exception handling and logging.</p><p>This package provides a single data access layer implementation that is simple and reusable by multiple services, reducing the amount of boilerplate code and keeping a consistent and well tested library.</p><p>The solution is split into two packages, <strong>Amido.Stacks.Data.Documents</strong> and <strong>Amido.Stacks.Data.Documents.CosmosDB</strong>.</p><br><h3 class="anchor anchorWithStickyNavbar_1iPN" id="document-storage">Document Storage<a aria-hidden="true" class="hash-link" href="#document-storage" title="Direct link to heading">‚Äã</a></h3><p>Package <strong>Amido.Stacks.Data.Documents</strong> contains the interface contracts for data access layers, it will define the operations available and decouple the contracts from the implementation. In the future, if the company decides to use other solutions like MongoDB, Cassandra or similar, will make it smooth to switch between servers without changing the code on services consuming it.</p><p>The contracts are defined by two interfaces IDocumentStorage and IDocumentSearch, as below, method signatures were removed for simplicity:</p><div class="codeBlockContainer_21wf"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_3oXa">IDocumentStorage</div><div class="codeBlockContent_1izB csharp"><pre tabindex="0" class="prism-code language-csharp codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">IDocumentStorage&lt;TEntity, in TEntityIdentityType&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Task&lt;OperationResult&lt;TEntity&gt;&gt; SaveAsync(TEntityIdentityType identifier, string partitionKey, TEntity document, string eTag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Task&lt;OperationResult&lt;TEntity&gt;&gt; GetByIdAsync(TEntityIdentityType identifier, string partitionKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Task&lt;OperationResult&gt; DeleteAsync(TEntityIdentityType identifier, string partitionKey);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><div class="codeBlockContainer_21wf"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_3oXa">IDocumentSearch</div><div class="codeBlockContent_1izB csharp"><pre tabindex="0" class="prism-code language-csharp codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">IDocumentSearch&lt;TEntity&gt; Task&lt;OperationResult&lt;IEnumerable&lt;TResult&gt;&gt;&gt; Search&lt;TResult, TOrderKey&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Expression&lt;Func&lt;TResult, bool&gt;&gt; searchPredicate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Expression&lt;Func&lt;TResult, TOrderKey&gt;&gt; orderPredicate = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool isAscendingOrder = true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string partitionKey = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int pageSize = 20,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int pageNumber = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Task&lt;OperationResult&lt;IEnumerable&lt;TResult&gt;&gt;&gt; RunSQLQueryAsync&lt;TResult&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string sqlQuery,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Dictionary&lt;string, object&gt; parameters = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string partitionKey = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int? MaxItemCount = null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string continuationToken = null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><p>The operations were decoupled into two interfaces to:</p><ul><li><p>Segregate Command operations from Read operations, except for GetById that is required for commands that need the full structure stored in DB in order to update it.</p></li><li><p>Separation of concerns, some implementations might not provide search capabilities, as it might be offloaded to a Search engine like ElasticSearch instead</p></li><li><p>Document databases might have separate storage for search each documents structure based on the search pattern, partition and indexes. In this case the documents stored in the search database will not match the schema of the original entity stored in the domain database.</p></li></ul><p><strong>It is expected that the implementations of these interfaces are reused between requests, for that reason it will be registered as singletons to improve the performance.</strong></p><p>Applications using the Document Storage does not need to be aware of the implementations, this is why you should only need the <strong>Amido.Stacks.Data.Documents</strong> namespace where it is being used. Doing so, will make easier to Mock DB dependencies when doing unit tests.</p><br><h3 class="anchor anchorWithStickyNavbar_1iPN" id="cosmosdb-package">CosmosDB Package<a aria-hidden="true" class="hash-link" href="#cosmosdb-package" title="Direct link to heading">‚Äã</a></h3><p>The CosmosDB implementation of the document storage is called CosmosDbDocumentStorage and is available in the package Amido.Stacks.Data.Documents.CosmosDB.</p><p>The package makes use of the CosmosDB SDK v3, that contains a few improvements compared to previous version, the most notorious one is the simplicity in the interfaces available, for more details, please check the announcements <a href="https://azure.microsoft.com/en-gb/blog/azure-cosmos-dotnet-sdk-version-3-0-now-in-public-preview/" target="_blank" rel="noopener noreferrer">here</a>.</p><p>A few details you should be aware when using the CosmosDB package from Stacks:</p><ul><li><p>The library use naming convention to map the Aggregate to the CosmosDB collection name(previous known as container), the library will map to the entity type name to a CosmosDB collection with same name, in the example below, the entity type is a Menu (like in a restaurant), a collection with same name should exist in the database(provisioned by DevOps).</p><ul><li><p>The collection name is not configurable because the configuration should be valid for any collection, otherwise multiple configuration would be required per table.</p></li><li><p>The package does not create the collection if one does not exist to avoid misconfiguration, which would generate new collections and cause unpredictable behaviours, because the application would continue working, but sending data to wrong collection.</p></li><li><p>Alternatively, you can add an Attribute <!-- -->[Table(‚ÄúCollectionName‚Äù]<!-- --> to the entity class name to map your entity to a collection with different name.</p></li></ul></li><li><p><strong>CosmosDbDocumentStorage</strong> is registered as a singleton object per collection, this is required in order to better reuse connections when calling CosmosDB resulting in a better performance.</p></li><li><p>CosmosDB requires a partition key to store the data, reusing the id as a partition key will make it performant and cheap for writes but will be expensive for reads that does not use the id as parameter.</p><ul><li><p>In case the application is heavy on read operations covering multiple partitions, you should consider a materialized collection partitioned and indexed according to the search parameters used for the query. Doing across partition query is an expensive operation and should be avoided.</p></li><li><p>Schema design is out of the scope of this guide, for a better design of your data, please watch this video with CosmosDB design patterns</p></li></ul></li></ul><p><strong>Usage:</strong>
When the package is used in the data access layer, as example a repository implementation, the package will make the data access logic simple and clean, off loading all the data access logic to the implemented storage.</p><div class="codeBlockContainer_21wf"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_3oXa">MenuRepository</div><div class="codeBlockContent_1izB csharp"><pre tabindex="0" class="prism-code language-csharp codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">public class MenuRepository : IMenuRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IDocumentStorage&lt;Menu, Guid&gt; documentStorage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MenuRepository(IDocumentStorage&lt;Menu, Guid&gt; documentStorage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.documentStorage = documentStorage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task&lt;Menu&gt; GetByIdAsync(Guid id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var result = await documentStorage.GetByIdAsync(id, id.ToString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.Content;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task&lt;bool&gt; SaveAsync(Menu entity)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var result = await documentStorage.SaveAsync(entity.Id, entity.Id.ToString(), entity, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.IsSuccessful;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task&lt;bool&gt; DeleteAsync(Guid id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var result = await documentStorage.DeleteAsync(id, id.ToString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.IsSuccessful;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><p>As seem above, the database implementation shouldn&#x27;t leak to the repository implementation, making it clean and readable.</p><p>Because document stores require a partition key to persist the data, it is required that the caller provides it on every call, in the example above, we are reusing the resource ID as the partition key, depending on the design, you might chose a different partition key that is only known by the application. Make sure you select a partition key that is know at query time, otherwise the application will execute cross partition queries when the partition key is not provided.</p><br><h3 class="anchor anchorWithStickyNavbar_1iPN" id="dependency-injection">Dependency Injection<a aria-hidden="true" class="hash-link" href="#dependency-injection" title="Direct link to heading">‚Äã</a></h3><p>In order to use the right implementation, we need to inject the dependencies in the IoC container before the application starts, the CosmosDB implementation provides an extension method called <strong>AddCosmosDB()</strong> from the namespace <strong>Amido.Stacks.Data.Documents.CosmosDB.Extensions</strong>, to use it, you just have to make a call to the extension in the dependency registration method of your application, like below:</p><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB csharp"><pre tabindex="0" class="prism-code language-csharp codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">public virtual void ConfigureServices(IServiceCollection services)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services.Configure&lt;CosmosDbConfiguration&gt;(context.Configuration.GetSection(&quot;CosmosDB&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services.AddCosmosDB();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services.AddSecrets(); //Required for CosmosDB configuration, see below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><p>The first like will load the configuration from appsettings.json and bind it to an instance of <strong>CosmosDbConfiguration</strong>, this will be injected in the CosmosDB constructor as <code>IOptions&lt;CosmosDbConfiguration&gt;</code>, please see the configuration details below.</p><p>The second like adds the <strong>CosmosDbDocumentStorage</strong> as a singleton implementation for <code>IDocumentStorage&lt;TEntity, in TEntityIdentityType&gt;</code> and <code>IDocumentSearch&lt;TEntity&gt;</code>.</p><p>The third line add the dependencies required to resolve password at runtime, password management has been described in the docs here.</p><br><h3 class="anchor anchorWithStickyNavbar_1iPN" id="configuration">Configuration<a aria-hidden="true" class="hash-link" href="#configuration" title="Direct link to heading">‚Äã</a></h3><p>The cosmos DB implementation requires 3 mandatory parameters in order to work properly, these are: AccountUri, DatabaseName and c.</p><p>the CosmosDbConfiguration represents these settings in the appssetings.json as a CosmosDB section(default) with the following structure:</p><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB json"><pre tabindex="0" class="prism-code language-json codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;CosmosDb&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;DatabaseAccountUri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://localhost:8081/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;DatabaseName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Stacks&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;SecurityKeySecret&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Identifier&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;COSMOSDBKEY&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Source&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Environment&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><ul><li>DatabaseAccountUri: is the url for the database account that host the databases in azure.</li><li>DatabaseName: is the name of the database used by the application. An account might have multiple database, but an application generally uses only one.</li><li>SecurityKeySecret: represents a secret that is stored elsewhere, the value of this secret will be passed to the SDK as SecurityKey for authentication with CosmosDB account.<ul><li>The secret might be hosted anywhere, within the container or on a remote server, for that reason, we use an identifier that will instruct the secret resolver where to find it. The secret management process is describe in the docs with more details.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_1iPN" id="operation-result">Operation Result<a aria-hidden="true" class="hash-link" href="#operation-result" title="Direct link to heading">‚Äã</a></h3><p>Every operation will return an <code>OperationResult&lt;T&gt;</code> response,  this is an object that represent the outcome of the operation, in case no exception is thrown, with the following details:</p><ul><li>IsSuccessful: Boolean flag that represents the status of the operation, in case it complete without exception.</li><li>Content: Depending on the type of the operation will return either bool, an entity object or a list of entities.</li><li>Attributes: A dictionary containing implementation specific data to be consumed by the application if required, for CosmosDB implementation, it returns the keys ETag and RequestCharge with it&#x27;s respective values.</li></ul><h3 class="anchor anchorWithStickyNavbar_1iPN" id="unit-tests">Unit Tests<a aria-hidden="true" class="hash-link" href="#unit-tests" title="Direct link to heading">‚Äã</a></h3><p>The library already have unit tests and integration tests covering the operations implemented. This does not prevent the consumer application of writing their own integration tests.</p><p>The tests implemented in the package is to ensure the package works for the intended scenarios, when applications start consuming it, some design decisions might not serialize properly, causing loss of data. For this reason, is really important that the consuming applications have tests converting at least Created+Read test to make sure the contents written to the DB are serialized and de-serialized correctly based on entity structure.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/workloads/azure/backend/netcore/architecture/project_structure_netcore"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ <!-- -->Solution Structure</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/workloads/azure/backend/netcore/architecture/operations_events_exceptions_correlation_netcore"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Operations, Events, Exceptions and Correlation<!-- --> ¬ª</div></a></div></nav></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">About Us</div><ul class="footer__items"><li class="footer__item"><a href="https://amido.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Amido<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Open Source</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/amido/amido.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Amido Ltd</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0d297d5a.js"></script>
<script src="/assets/js/main.156a79fa.js"></script>
</body>
</html>