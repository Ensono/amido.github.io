"use strict";(self.webpackChunkstacks=self.webpackChunkstacks||[]).push([[1695],{3378:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>l,metadata:()=>d,toc:()=>u});var a=t(4848),s=t(8453),r=t(1470),o=t(9365);const l={id:"nextjs_plugin",title:"Ensono Stacks with NextJs Module Federation",sidebar_label:"Ensono Stacks Module Federation",description:"Using Ensono Stacks with NextJs Module Federation",keywords:["Nx","monorepo","stacks","Generator","Executor","ensono"]},i=void 0,d={id:"module_federation/nextjs_plugin",title:"Ensono Stacks with NextJs Module Federation",description:"Using Ensono Stacks with NextJs Module Federation",source:"@site/docs/module_federation/nextjs_plugin.md",sourceDirName:"module_federation",slug:"/module_federation/nextjs_plugin",permalink:"/docs/module_federation/nextjs_plugin",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"nextjs_plugin",title:"Ensono Stacks with NextJs Module Federation",sidebar_label:"Ensono Stacks Module Federation",description:"Using Ensono Stacks with NextJs Module Federation",keywords:["Nx","monorepo","stacks","Generator","Executor","ensono"]},sidebar:"docs",previous:{title:"Getting Started",permalink:"/docs/getting_started/setup"},next:{title:"Overview",permalink:"/docs/nextjs/authentication"}},c={},u=[{value:"Module Federation with NextJs",id:"module-federation-with-nextjs",level:4},{value:"NextJs Module Federation with Ensono Stacks",id:"nextjs-module-federation-with-ensono-stacks",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Nx",id:"nx",level:4},{value:"Node",id:"node",level:4},{value:"Get Started",id:"get-started",level:3},{value:"Create a new Ensono Stacks and Nx workspace",id:"create-a-new-ensono-stacks-and-nx-workspace",level:4}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:'Microfrontends are an architectural pattern for building frontend applications by breaking them down into smaller, loosely coupled, and independently deployable parts called "micro-frontends." Each microfrontend corresponds to a distinct feature or functionality of the application and is developed and deployed independently of the others.'}),"\n",(0,a.jsx)(n.h4,{id:"module-federation-with-nextjs",children:"Module Federation with NextJs"}),"\n",(0,a.jsx)(n.p,{children:"Module Federation is a feature introduced in Webpack 5, it enables developers to share code dynamically across different applications at runtime. This feature is particularly beneficial when building microfrontends or decoupled frontend architectures."}),"\n",(0,a.jsx)(n.p,{children:"@module-federation/nextjs-mf is a plugin that leverages Webpack 5\u2019s Module Federation features, allowing developers to implement Module Federation in NextJs applications."}),"\n",(0,a.jsx)(n.p,{children:"It aims to enable a federated modules architecture in NextJs, enabling you to split a monolithic NextJs application into smaller, independently deployable parts."}),"\n",(0,a.jsxs)(n.p,{children:["The following guide details the steps of how to set up Module Federation with a Ensono Stacks NextJs application. You can also visit this ",(0,a.jsx)(n.a,{href:"https://github.com/Ensono/stacks-nextjs-federated-modules-example",children:"GitHub repo"})," to view an existing example application"]}),"\n",(0,a.jsx)(n.h2,{id:"nextjs-module-federation-with-ensono-stacks",children:"NextJs Module Federation with Ensono Stacks"}),"\n",(0,a.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsx)(n.h4,{id:"nx",children:"Nx"}),"\n",(0,a.jsx)(n.p,{children:"We recommend installing Nx globally, all Nx based commands in this guide are based upon a globally installed Nx package."}),"\n",(0,a.jsxs)(r.A,{children:[(0,a.jsx)(o.A,{value:"npm",label:"npm",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npm install -g nx\n"})})}),(0,a.jsx)(o.A,{value:"yarn",label:"yarn",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"yarn global add nx\n"})})})]}),"\n",(0,a.jsx)(n.h4,{id:"node",children:"Node"}),"\n",(0,a.jsxs)(n.p,{children:["We recommend using the latest LTS version of Node, you can find the latest LTS version ",(0,a.jsx)(n.a,{href:"https://nodejs.org/en/",children:"here"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"get-started",children:"Get Started"}),"\n",(0,a.jsx)(n.h4,{id:"create-a-new-ensono-stacks-and-nx-workspace",children:"Create a new Ensono Stacks and Nx workspace"}),"\n",(0,a.jsxs)(n.p,{children:["You can scaffold a brand-new Ensono Stacks and Nx workspace using the ",(0,a.jsx)(n.strong,{children:"@ensono-stacks/create-stacks-workspace"})," package."]}),"\n",(0,a.jsxs)(n.p,{children:["Follow the interactive questions creating a new NextJs application named ",(0,a.jsx)("b",{children:"host"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx @ensono-stacks/create-stacks-workspace@latest\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsxs)(n.p,{children:["Visit the ",(0,a.jsx)(n.a,{href:"/docs/getting_started/create-stacks-workspace/ensono-stacks-create-stacks-workspace",children:"@ensono-stacks/create-stacks-workspace"})," docs for more information and setup instructions!"]})}),"\n",(0,a.jsxs)(n.p,{children:["This will generate a new Ensono Stacks Nx workspace containing a NextJs ",(0,a.jsx)("b",{children:"host"})," application"]}),"\n",(0,a.jsx)(n.p,{children:"First We need to install the NextJs federated modules plugin"}),"\n",(0,a.jsxs)(r.A,{children:[(0,a.jsx)(o.A,{value:"npm",label:"npm",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npm add @module-federation/nextjs-mf\n"})})}),(0,a.jsx)(o.A,{value:"yarn",label:"yarn",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"yarn add @module-federation/nextjs-mf\n"})})})]}),"\n",(0,a.jsxs)(n.p,{children:["Create a new ",(0,a.jsx)("b",{children:"header"})," application which will be our remote module, we can do this manually or by using the Nx CLI."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"nx g @nx/next:app header --no-appDir\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now we have both our ",(0,a.jsx)("b",{children:"host"})," and ",(0,a.jsx)("b",{children:"header"})," modules, we need to update various config in each application to enable module federation."]}),"\n",(0,a.jsxs)(n.p,{children:["Let's update the header ",(0,a.jsx)(n.code,{children:"next.config"})," with details of our remote ",(0,a.jsx)("b",{children:"header"})," module.\n",(0,a.jsx)("b",{children:"header/next.config"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const NextFederationPlugin = require('@module-federation/nextjs-mf');\nconst { withNx } = require('@nrwl/next/plugins/with-nx');\nconst path = require('node:path');\n\nmodule.exports = withNx({\n    output: 'standalone',\n    experimental: {\n        outputFileTracingRoot: path.join(__dirname, '../../')\n    },\n    webpack(config) {\n        config.plugins.push(\n            new NextFederationPlugin({\n                name: 'header',\n                filename: 'static/chunks/remoteEntry.js',\n                exposes: {\n                    './index': './pages/index.tsx',\n                },\n            }),\n        );\n        return config;\n    }\n});\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Create an new env file for the ",(0,a.jsx)("b",{children:"header"})," app with the addresses of our ",(0,a.jsx)("b",{children:"host"})," and ",(0,a.jsx)("b",{children:"header"})," modules.\n",(0,a.jsx)("b",{children:"header/.env.development"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dotenv",children:'STACKS_PUBLIC_HOST_URL="http://localhost:4200"\nSTACKS_PUBLIC_HEADER_URL="http://localhost:4300"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Then update the header modules ",(0,a.jsx)(n.code,{children:"project.json"})," with the port on which the header module will be hosted\n",(0,a.jsx)("b",{children:"header/project.json"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n    "serve": {\n        "executor": "@nx/next:server",\n        "defaultConfiguration": "development",\n        "options": {\n            "buildTarget": "header:build",\n            "dev": true,\n            "port": 4300\n        }\n    }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Lets update the header module component to make it a bit more readable."}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)("b",{children:"header/pages/index.tsx"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:'export function Index() {\n    return (\n        <>\n            <div className="wrapper">\n                <div className="container">\n                    <div id="welcome">\n                        <h1>\n                            Header \ud83d\udc4b\n                        </h1>\n                    </div>\n                </div>\n            </div>\n        </>\n    );\n}\n\nexport default Index;\n\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Now we need to update the host modules ",(0,a.jsx)(n.code,{children:"next.config.ts"})," with details of the ",(0,a.jsx)("b",{children:"host"})," and any remote modules.\n",(0,a.jsx)("b",{children:"host/next.config.t\ns"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"const NextFederationPlugin = require('@module-federation/nextjs-mf');\nconst { withNx } = require('@nrwl/next/plugins/with-nx');\nconst path = require('node:path');\n\nconst remotes = isServer => {\n    const location = isServer ? 'ssr' : 'chunks';\n\n    return {\n        header: `header@${process.env.STACKS_PUBLIC_HEADER_URL}/_next/static/${location}/remoteEntry.js`,\n    };\n};\n\nmodule.exports = withNx({\n    output: 'standalone',\n    experimental: {\n        outputFileTracingRoot: path.join(__dirname, '../../'),\n        scrollRestoration: true\n    },\n    webpack(config, options) {\n        config.plugins.push(\n            new NextFederationPlugin({\n                name: 'host',\n                filename: 'static/chunks/remoteEntry.js',\n                remotes: remotes(options.isServer),\n            }),\n        );\n\n        return config;\n    }\n});\n"})}),"\n",(0,a.jsxs)(n.p,{children:["As with the ",(0,a.jsx)("b",{children:"header"})," module, we also need to add a new env file to the ",(0,a.jsx)("b",{children:"host"})," application\n",(0,a.jsx)("b",{children:"host/.env.development"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dotenv",children:'STACKS_PUBLIC_HOST_URL="http://localhost:4200"\nSTACKS_PUBLIC_HEADER_URL="http://localhost:4300"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Also updating the ",(0,a.jsx)("b",{children:"host"})," modules ",(0,a.jsx)(n.code,{children:"project.json"})," with the correct port number"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n    "serve": {\n        "executor": "@nx/next:server",\n        "defaultConfiguration": "development",\n        "options": {\n            "buildTarget": "host:build",\n            "dev": true,\n            "port": 4200\n        }\n    }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["We can then import the ",(0,a.jsx)("b",{children:"header"})," module into the ",(0,a.jsx)("b",{children:"host"})," in the ",(0,a.jsx)(n.code,{children:"_app.tsx"})," file\n",(0,a.jsx)("b",{children:"host/pages/_app.tsx"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"import { AppProps } from 'next/app';\nimport Head from 'next/head';\nimport Header from 'header/index';\nimport './styles.css';\n\nfunction CustomApp({ Component, pageProps }: AppProps) {\n    return (\n        <>\n            <Head>\n                <title>Welcome to host!</title>\n            </Head>\n            <Header />\n            <main className=\"app\">\n                <Component {...pageProps} />\n            </main>\n        </>\n    );\n}\n\nexport default CustomApp;\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now run the app with the following command"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"nx run-many --target=serve\n"})}),"\n",(0,a.jsxs)(n.p,{children:["We can then visit ",(0,a.jsx)(n.a,{href:"http://localhost:4200/",children:"localhost:4200"})," and see the ",(0,a.jsx)("b",{children:"header"})," module running inside the ",(0,a.jsx)("b",{children:"host"})," application.\nOr we can visit ",(0,a.jsx)(n.a,{href:"http://localhost:4300/",children:"localhost:4300"})," and see the ",(0,a.jsx)("b",{children:"header"})," module hosted independently."]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},9365:(e,n,t)=>{t.d(n,{A:()=>o});t(6540);var a=t(4164);const s={tabItem:"tabItem_Ymn6"};var r=t(4848);function o(e){let{children:n,hidden:t,className:o}=e;return(0,r.jsx)("div",{role:"tabpanel",className:(0,a.A)(s.tabItem,o),hidden:t,children:n})}},1470:(e,n,t)=>{t.d(n,{A:()=>k});var a=t(6540),s=t(4164),r=t(3104),o=t(6347),l=t(205),i=t(7485),d=t(1682),c=t(679);function u(e){var n,t;return null!=(n=null==(t=a.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})))?void 0:t.filter(Boolean))?n:[]}function h(e){const{values:n,children:t}=e;return(0,a.useMemo)((()=>{const e=null!=n?n:function(e){return u(e).map((e=>{let{props:{value:n,label:t,attributes:a,default:s}}=e;return{value:n,label:t,attributes:a,default:s}}))}(t);return function(e){const n=(0,d.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error('Docusaurus error: Duplicate values "'+n.map((e=>e.value)).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function x(e){let{queryString:n=!1,groupId:t}=e;const s=(0,o.W6)(),r=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=t?t:null}({queryString:n,groupId:t});return[(0,i.aZ)(r),(0,a.useCallback)((e=>{if(!r)return;const n=new URLSearchParams(s.location.search);n.set(r,e),s.replace({...s.location,search:n.toString()})}),[r,s])]}function m(e){const{defaultValue:n,queryString:t=!1,groupId:s}=e,r=h(e),[o,i]=(0,a.useState)((()=>function(e){var n;let{defaultValue:t,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!p({value:t,tabValues:a}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+t+'" but none of its children has the corresponding value. Available values are: '+a.map((e=>e.value)).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return t}const s=null!=(n=a.find((e=>e.default)))?n:a[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:r}))),[d,u]=x({queryString:t,groupId:s}),[m,f]=function(e){let{groupId:n}=e;const t=function(e){return e?"docusaurus.tab."+e:null}(n),[s,r]=(0,c.Dv)(t);return[s,(0,a.useCallback)((e=>{t&&r.set(e)}),[t,r])]}({groupId:s}),j=(()=>{const e=null!=d?d:m;return p({value:e,tabValues:r})?e:null})();(0,l.A)((()=>{j&&i(j)}),[j]);return{selectedValue:o,selectValue:(0,a.useCallback)((e=>{if(!p({value:e,tabValues:r}))throw new Error("Can't select invalid tab value="+e);i(e),u(e),f(e)}),[u,f,r]),tabValues:r}}var f=t(2303);const j={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var g=t(4848);function b(e){let{className:n,block:t,selectedValue:a,selectValue:o,tabValues:l}=e;const i=[],{blockElementScrollPositionUntilNextRender:d}=(0,r.a_)(),c=e=>{const n=e.currentTarget,t=i.indexOf(n),s=l[t].value;s!==a&&(d(n),o(s))},u=e=>{var n;let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{var a;const n=i.indexOf(e.currentTarget)+1;t=null!=(a=i[n])?a:i[0];break}case"ArrowLeft":{var s;const n=i.indexOf(e.currentTarget)-1;t=null!=(s=i[n])?s:i[i.length-1];break}}null==(n=t)||n.focus()};return(0,g.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":t},n),children:l.map((e=>{let{value:n,label:t,attributes:r}=e;return(0,g.jsx)("li",{role:"tab",tabIndex:a===n?0:-1,"aria-selected":a===n,ref:e=>i.push(e),onKeyDown:u,onClick:c,...r,className:(0,s.A)("tabs__item",j.tabItem,null==r?void 0:r.className,{"tabs__item--active":a===n}),children:null!=t?t:n},n)}))})}function v(e){let{lazy:n,children:t,selectedValue:r}=e;const o=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=o.find((e=>e.props.value===r));return e?(0,a.cloneElement)(e,{className:(0,s.A)("margin-top--md",e.props.className)}):null}return(0,g.jsx)("div",{className:"margin-top--md",children:o.map(((e,n)=>(0,a.cloneElement)(e,{key:n,hidden:e.props.value!==r})))})}function w(e){const n=m(e);return(0,g.jsxs)("div",{className:(0,s.A)("tabs-container",j.tabList),children:[(0,g.jsx)(b,{...n,...e}),(0,g.jsx)(v,{...n,...e})]})}function k(e){const n=(0,f.A)();return(0,g.jsx)(w,{...e,children:u(e.children)},String(n))}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var a=t(6540);const s={},r=a.createContext(s);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);