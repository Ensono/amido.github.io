"use strict";(self.webpackChunkstacks=self.webpackChunkstacks||[]).push([[4443],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),f=r,m=c["".concat(s,".").concat(f)]||c[f]||d[f]||i;return n?a.createElement(m,o(o({ref:t},u),{},{components:n})):a.createElement(m,o({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=f;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},5162:function(e,t,n){n.d(t,{Z:function(){return o}});var a=n(7294),r=n(6010),i={tabItem:"tabItem_Ymn6"};function o(e){var t=e.children,n=e.hidden,o=e.className;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(i.tabItem,o),hidden:n},t)}},4866:function(e,t,n){n.d(t,{Z:function(){return w}});var a=n(7462),r=n(7294),i=n(6010),o=n(2466),l=n(6550),s=n(1980),p=n(7392),u=n(12);function c(e){return function(e){var t,n;return null!=(t=null==(n=r.Children.map(e,(function(e){if(!e||(0,r.isValidElement)(e)&&(t=e.props)&&"object"==typeof t&&"value"in t)return e;var t;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})))?void 0:n.filter(Boolean))?t:[]}(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}function d(e){var t=e.values,n=e.children;return(0,r.useMemo)((function(){var e=null!=t?t:c(n);return function(e){var t=(0,p.l)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,n])}function f(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function m(e){var t=e.queryString,n=void 0!==t&&t,a=e.groupId,i=(0,l.k6)(),o=function(e){var t=e.queryString,n=void 0!==t&&t,a=e.groupId;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=a?a:null}({queryString:n,groupId:a});return[(0,s._X)(o),(0,r.useCallback)((function(e){if(o){var t=new URLSearchParams(i.location.search);t.set(o,e),i.replace(Object.assign({},i.location,{search:t.toString()}))}}),[o,i])]}function h(e){var t,n,a,i,o=e.defaultValue,l=e.queryString,s=void 0!==l&&l,p=e.groupId,c=d(e),h=(0,r.useState)((function(){return function(e){var t,n=e.defaultValue,a=e.tabValues;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!f({value:n,tabValues:a}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+n+'" but none of its children has the corresponding value. Available values are: '+a.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return n}var r=null!=(t=a.find((function(e){return e.default})))?t:a[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:o,tabValues:c})})),v=h[0],b=h[1],k=m({queryString:s,groupId:p}),g=k[0],y=k[1],w=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:p}.groupId),n=(0,u.Nk)(t),a=n[0],i=n[1],[a,(0,r.useCallback)((function(e){t&&i.set(e)}),[t,i])]),N=w[0],S=w[1],x=function(){var e=null!=g?g:N;return f({value:e,tabValues:c})?e:null}();return(0,r.useLayoutEffect)((function(){x&&b(x)}),[x]),{selectedValue:v,selectValue:(0,r.useCallback)((function(e){if(!f({value:e,tabValues:c}))throw new Error("Can't select invalid tab value="+e);b(e),y(e),S(e)}),[y,S,c]),tabValues:c}}var v=n(2389),b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function k(e){var t=e.className,n=e.block,l=e.selectedValue,s=e.selectValue,p=e.tabValues,u=[],c=(0,o.o5)().blockElementScrollPositionUntilNextRender,d=function(e){var t=e.currentTarget,n=u.indexOf(t),a=p[n].value;a!==l&&(c(t),s(a))},f=function(e){var t,n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":var a,r=u.indexOf(e.currentTarget)+1;n=null!=(a=u[r])?a:u[0];break;case"ArrowLeft":var i,o=u.indexOf(e.currentTarget)-1;n=null!=(i=u[o])?i:u[u.length-1]}null==(t=n)||t.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},t)},p.map((function(e){var t=e.value,n=e.label,o=e.attributes;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:function(e){return u.push(e)},onKeyDown:f,onClick:d},o,{className:(0,i.Z)("tabs__item",b.tabItem,null==o?void 0:o.className,{"tabs__item--active":l===t})}),null!=n?n:t)})))}function g(e){var t=e.lazy,n=e.children,a=e.selectedValue,i=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){var o=i.find((function(e){return e.props.value===a}));return o?(0,r.cloneElement)(o,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},i.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a})})))}function y(e){var t=h(e);return r.createElement("div",{className:(0,i.Z)("tabs-container",b.tabList)},r.createElement(k,(0,a.Z)({},e,t)),r.createElement(g,(0,a.Z)({},e,t)))}function w(e){var t=(0,v.Z)();return r.createElement(y,(0,a.Z)({key:String(t)},e))}},6912:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return c}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=(n(4866),n(5162),["components"]),l={id:"maven_spring_profiles",title:"Maven & Spring Profiles",sidebar_label:"Maven & Spring Profiles",hide_title:!1,hide_table_of_contents:!1,description:"Maven & Spring Profiles",keywords:["java","rest","api","ide","maven","spring","profiles","pom"]},s=void 0,p={unversionedId:"workloads/common/backend/java/maven_spring_profiles",id:"workloads/common/backend/java/maven_spring_profiles",title:"Maven & Spring Profiles",description:"Maven & Spring Profiles",source:"@site/docs/workloads/common/backend/java/maven_spring_profiles.md",sourceDirName:"workloads/common/backend/java",slug:"/workloads/common/backend/java/maven_spring_profiles",permalink:"/docs/workloads/common/backend/java/maven_spring_profiles",draft:!1,tags:[],version:"current",frontMatter:{id:"maven_spring_profiles",title:"Maven & Spring Profiles",sidebar_label:"Maven & Spring Profiles",hide_title:!1,hide_table_of_contents:!1,description:"Maven & Spring Profiles",keywords:["java","rest","api","ide","maven","spring","profiles","pom"]},sidebar:"docs",previous:{title:"IDE guidelines",permalink:"/docs/workloads/common/backend/java/ide_java"},next:{title:"Modularity Overview",permalink:"/docs/workloads/common/backend/java/architecture/maven_modules_java"}},u={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Maven Build Profiles",id:"maven-build-profiles",level:2},{value:"Spring Profiles",id:"spring-profiles",level:2},{value:"application-aws.yml",id:"application-awsyml",level:3},{value:"application-azure.yml",id:"application-azureyml",level:3},{value:"Stacks Profile Usage",id:"stacks-profile-usage",level:2},{value:"Support Scripts",id:"support-scripts",level:2},{value:"run_scenario.sh",id:"run_scenariosh",level:3},{value:"deploy_scenario.sh",id:"deploy_scenariosh",level:3}],d={toc:c},f="wrapper";function m(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)(f,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"This page describes the use of Maven Build profiles and Spring profiles to support the use of feature sets within Stacks. The\nterm 'feature sets' means provider support for common tasks such as persistence and message queue handling. It allows the selection\nof different mechanisms across different cloud providers (such as the use of CosmosDB on Azure, or DynamoDB on AWS)."),(0,i.kt)("h2",{id:"maven-build-profiles"},"Maven Build Profiles"),(0,i.kt)("p",null,"Maven build profiles can be used to create customised build configurations, like targeting a level of test granularity or a\nspecific deployment environment or feature set."),(0,i.kt)("p",null,"The profiles are specified in the applications ",(0,i.kt)("inlineCode",{parentName:"p"},"pom.xml")," and provide the capability for a number of different elements of\nthe project object model, such as dependencies and properties to be overridden by passing switches at startup. The profiles\nare available to all Maven lifecycles such as compile, test and package."),(0,i.kt)("p",null,"An example of a profile definition is shown below: -"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"<profile>\n  <id>aws</id>\n  <activation>\n    <file>\n      <exists>.</exists>\n    </file>\n  </activation>\n  <properties>\n    <aws.profile.name>aws</aws.profile.name>\n  </properties>\n  <dependencies>\n    \x3c!-- AWS Specific Dependencies Go Here --\x3e\n  </dependencies>\n</profile>\n")),(0,i.kt)("p",null,"It is possible to specify profiles as being active via a number of mechanisms (one option is show above) and then for\nthese to be enabled or disabled on the command line as per requirements."),(0,i.kt)("p",null,"An example of starting the application and specifying profiles is as follows - this command switches off the ",(0,i.kt)("inlineCode",{parentName:"p"},"aws")," profile and\nswitches on the ",(0,i.kt)("inlineCode",{parentName:"p"},"azure")," profile: -"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"mvn clean spring-boot:run -P-aws,azure\n")),(0,i.kt)("h2",{id:"spring-profiles"},"Spring Profiles"),(0,i.kt)("p",null,"Spring Profiles are a core feature of the Spring framework, allowing developers to map beans and properties to different\nprofiles."),(0,i.kt)("p",null,"Activating a certain profile can have a huge effect on a Spring Boot application, but under the hood, a profile can merely\ncontrol two things:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"a profile may influence the application properties, and"),(0,i.kt)("li",{parentName:"ul"},"a profile may influence which beans are loaded into the application context")),(0,i.kt)("p",null,"In the Java code it is possible to specify that Spring beans should only be loaded into the context if the profile has been\nactivated: -"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'@Component\n@Profile("foo")\npublic class FooBean { ... }\n')),(0,i.kt)("p",null,"When using Spring Boot any application properties are typically placed into a file under ",(0,i.kt)("inlineCode",{parentName:"p"},"resources")," called ",(0,i.kt)("inlineCode",{parentName:"p"},"application.yml"),"\n(or alternatively ",(0,i.kt)("inlineCode",{parentName:"p"},"application.properties"),"). "),(0,i.kt)("p",null,"When using Spring Profiles it is possible to create individual application property files per profile; this gives a clean\nseparation between property settings. The example below shows properties that are only loaded (and overlay any similarly named\nproperties in the base file) if the relevant profile is activated on the command line."),(0,i.kt)("h3",{id:"application-awsyml"},"application-aws.yml"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"aws:\n  xray:\n    enabled: ${AWS_XRAY_ENABLED:false}\n  secretsmanager:\n    enabled: ${AWS_SECRETS_ENABLED:false}\n")),(0,i.kt)("h3",{id:"application-azureyml"},"application-azure.yml"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"azure:\n  application-insights:\n    instrumentation-key: xxxxxx\n    enabled: true\n")),(0,i.kt)("p",null,"There are multiple ways to specify the profiles at application startup. A few examples are shown below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"export SPRING_PROFILES_ACTIVE=foo,bar\njava -jar profiles-0.0.1-SNAPSHOT.jar\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"java -Dspring.profiles.active=foo -jar profiles-0.0.1-SNAPSHOT.jar\n")),(0,i.kt)("h2",{id:"stacks-profile-usage"},"Stacks Profile Usage"),(0,i.kt)("p",null,"Stacks projects have been configured with both Maven and Spring profiles in order to support the capability of being able to\neasily isolate dependencies and properties between feature sets (such as cloud provider, persistence and messaging). "),(0,i.kt)("p",null,"The ultimate aim of Stacks is for a project to be able to deploy an instance that is as close to developer-written code as possible, whilst\nstill providing a rich feature set that projects can choose from. It is also a requirement to make the Stacks maintainer experience as\nsimple as possible and to allow developers and testers an easy way to switch between feature sets whilst providing a platform for them\nto extend Stacks with new feature sets in the future."),(0,i.kt)("p",null,"The use of both profile mechanisms allow dependencies and properties to be nicely ring-fenced, making it relatively easy for\nsupporting scripts to be able to re-package the Stacks project and for it to be tailored more closely to a projects requirements."),(0,i.kt)("p",null,"The three Stacks workloads differ slightly in their provided capability, so this text will now focus on the Stacks CQRS with Events\nproject as that provides the richest set of features."),(0,i.kt)("p",null,"The following areas within the project have been configured to provide profile support: -"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"pom.xml")," - default properties assigned for all features"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"pom.xml")," - Maven build profiles created, one per feature"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"resources/application.yml")," - set of Spring profiles to auto-include based on flags passed to Maven (see ",(0,i.kt)("inlineCode",{parentName:"li"},"spring.profiles.include"),")"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"resources/application-PROFILE_NAME.yml")," - application properties specific to each feature")),(0,i.kt)("p",null,"As per the section above on Maven Build Profiles it can be seen that a few of the profiles have been enabled by default. This is\nto provide backwards-compatibility and to ensure that the application runs even if no profiles are specified on the command line.\nThe profiles that have been enabled at this time by default are ",(0,i.kt)("inlineCode",{parentName:"p"},"aws"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"azure"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"cosmosdb")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"servicebus"),"."),(0,i.kt)("p",null,"To start the application using a different configuration, say to use ",(0,i.kt)("inlineCode",{parentName:"p"},"dynamodb")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"sqs")," instead, the following command can be used to\nswitch off the profiles that aren't required and activate the ones that are. Remember that some profiles are always activated (unless switched\noff by prefixing with a ",(0,i.kt)("inlineCode",{parentName:"p"},"-")," character) so these do not need to be explicitly specified: -"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"mvn clean spring-boot:run -Pdynamodb,sqs,-cosmosdb,-servicebus\n")),(0,i.kt)("p",null,"Note that some profiles are mutually exclusive (the persistence and messaging handler profiles) so the application will fail at startup if\ninvalid (overlapping) profiles are specified."),(0,i.kt)("h2",{id:"support-scripts"},"Support Scripts"),(0,i.kt)("p",null,"A number of support scripts are included in the projects that aid in the use of profiles."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f The Cloud-related profiles (",(0,i.kt)("strong",{parentName:"p"},"AWS & Azure"),") do not currently provide as clean a separation of dependencies as possible -\nall library dependencies will be included irrespective of whether they are selected or not - this issue will be fixed in a later release.")),(0,i.kt)("h3",{id:"run_scenariosh"},"run_scenario.sh"),(0,i.kt)("p",null,"This script is aimed at ",(0,i.kt)("strong",{parentName:"p"},"Stacks developers & testers"),"."),(0,i.kt)("p",null,"This bash script provides a command line interface to the user to allow them to select the feature sets they want to start the\nSpring Boot application with. "),(0,i.kt)("p",null,"After making their choices it will display the Maven command that will be executed, and then optionally run it for the user."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sh run_scenario.sh\n\n1. Please select the Cloud required:\n\n   [x]   azure (Azure Cloud)\n   [x]   aws (AWS Cloud)\n\n2. Please select the Persistence required:\n\n   [ ]   cosmosdb (CosmosDB)\n   [x]   dynamodb (DynamoDB)\n\n3. Please select the Message Handler required:\n\n   [ ]   servicebus (Azure ServiceBus)\n   [ ]   kafka (AWS Kafka)\n   [x]   sqs (AWS SQS)\n\nYou have selected these options for your project:\n\n   * azure\n   * aws\n   * dynamodb\n   * sqs\n\nAbout to execute:\n\n   mvn clean spring-boot:run -Pazure,aws,dynamodb,sqs,-cosmosdb,-servicebus\n\nPress ENTER to accept or CTRL-C to quit\n")),(0,i.kt)("h3",{id:"deploy_scenariosh"},"deploy_scenario.sh"),(0,i.kt)("p",null,"This script is aimed at ",(0,i.kt)("strong",{parentName:"p"},"Stacks adopters & end projects"),"."),(0,i.kt)("p",null,"This bash script provides a command line interface to the user to allow them to select the feature sets they want to deploy the\nSpring Boot application with. After making their feature set choice it will alter the code project from being one that supports\nmultiple feature sets to being one that has the features baked-in."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sh deploy_scenario.sh\n\n1. Please select the Cloud required:\n\n   [x]   azure (Azure Cloud)\n   [x]   aws (AWS Cloud)\n\n2. Please select the Persistence required:\n\n   [ ]   cosmosdb (CosmosDB)\n   [x]   dynamodb (DynamoDB)\n\n3. Please select the Message Handler required:\n\n   [ ]   servicebus (Azure ServiceBus)\n   [x]   kafka (AWS Kafka)\n   [ ]   sqs (AWS SQS)\n\nYou have selected these options for your project:\n\n   * azure\n   * aws\n   * dynamodb\n   * kafka\n\nPress ENTER to accept or CTRL-C to quit\n")),(0,i.kt)("p",null,"After pressing ENTER the script will perform the following actions: -"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Move feature-set related Maven Dependencies to the main library dependencies section in ",(0,i.kt)("inlineCode",{parentName:"li"},"pom.xml")),(0,i.kt)("li",{parentName:"ol"},"Remove any non-required feature-set related Maven Build profiles from ",(0,i.kt)("inlineCode",{parentName:"li"},"pom.xml")),(0,i.kt)("li",{parentName:"ol"},"Remove any non-required feature-set related Maven Build properties from ",(0,i.kt)("inlineCode",{parentName:"li"},"pom.xml")),(0,i.kt)("li",{parentName:"ol"},"Hard-code the feature-set related Spring Profile list in ",(0,i.kt)("inlineCode",{parentName:"li"},"application.yml")," (and remove any unused profiles)"),(0,i.kt)("li",{parentName:"ol"},"Remove any non-required Spring profile ",(0,i.kt)("inlineCode",{parentName:"li"},"resources/application-PROFILE_NAME.yml")," files")),(0,i.kt)("p",null,"After these operations the Stacks project code should be closer to how a Project would manually craft their application code."))}m.isMDXComponent=!0}}]);