"use strict";(self.webpackChunkstacks=self.webpackChunkstacks||[]).push([[7080],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return f}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=u(n),m=a,f=p["".concat(s,".").concat(m)]||p[m]||d[m]||o;return n?r.createElement(f,i(i({ref:t},c),{},{components:n})):r.createElement(f,i({ref:t},c))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:a,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1619:function(e,t,n){var r=n(7294);t.Z=function(e){var t=e.next,n=e.prev;return r.useEffect((function(){if(t){var e=document.querySelector("div.pagination-nav__item.pagination-nav__item--next>a");e&&e.style&&(e.style.display="none")}if(n){var r=document.querySelector("div.pagination-nav__item>a");r&&r.style&&(r.style.display="none")}})),r.createElement("div",null)}},9453:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return c},default:function(){return g},frontMatter:function(){return u},metadata:function(){return p},toc:function(){return m}});var r=n(7462),a=n(3366),o=(n(7294),n(3905)),i=n(1619),l=n(4996),s=["components"],u={id:"core_infrastructure",title:"Azure Core Infrastructure",sidebar_label:"Core Infrastructure",description:"How to bootstrap the Azure tenant",keywords:["azure devops","scaffolding cli","workload","pipeline","pipeline template","resources"]},c=void 0,p={unversionedId:"infrastructure/azure/core_infrastructure",id:"infrastructure/azure/core_infrastructure",title:"Azure Core Infrastructure",description:"How to bootstrap the Azure tenant",source:"@site/docs/infrastructure/azure/core_infrastructure.md",sourceDirName:"infrastructure/azure",slug:"/infrastructure/azure/core_infrastructure",permalink:"/docs/infrastructure/azure/core_infrastructure",draft:!1,tags:[],version:"current",frontMatter:{id:"core_infrastructure",title:"Azure Core Infrastructure",sidebar_label:"Core Infrastructure",description:"How to bootstrap the Azure tenant",keywords:["azure devops","scaffolding cli","workload","pipeline","pipeline template","resources"]},sidebar:"docs",previous:{title:"Introduction",permalink:"/docs/infrastructure/introduction"},next:{title:"Azure DevOps",permalink:"/docs/infrastructure/azure/pipelines/azure_devops"}},d={},m=[{value:"Resources Provisioned",id:"resources-provisioned",level:2},{value:"Diagram",id:"diagram",level:3},{value:"Resource List",id:"resource-list",level:3},{value:"Deploying",id:"deploying",level:2},{value:"Bootstrap the Azure tenant",id:"bootstrap-the-azure-tenant",level:3},{value:"Using the Scaffolding CLI",id:"using-the-scaffolding-cli",level:3},{value:"Pipelines",id:"pipelines",level:3},{value:"Running Locally",id:"running-locally",level:3}],f={toc:m},k="wrapper";function g(e){var t=e.components,n=(0,a.Z)(e,s);return(0,o.kt)(k,(0,r.Z)({},f,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The core infrastructure is the foundation for all other Stacks Workloads. As, in most cases, this will be the first part of Stacks that you deploy we will also cover bootstrapping your Azure tenant."),(0,o.kt)("h2",{id:"resources-provisioned"},"Resources Provisioned"),(0,o.kt)("p",null,"Both the diagram and resource list below are for a single environment. By default, the pipeline template will create two environments (nonprod and prod)."),(0,o.kt)("h3",{id:"diagram"},"Diagram"),(0,o.kt)("img",{alt:"Azure Core Infrastructure",src:(0,l.Z)("img/azure_core_infrastructure.png")}),(0,o.kt)("h3",{id:"resource-list"},"Resource List"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Resource"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Resource Group"),(0,o.kt)("td",{parentName:"tr",align:null},"Used to logically group infrastructure")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Virtual Network"),(0,o.kt)("td",{parentName:"tr",align:null},"Fundamental building block for the private network")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Subnet - AGW"),(0,o.kt)("td",{parentName:"tr",align:null},"Dedicated subnet required for Application Gateway")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Application Gateway"),(0,o.kt)("td",{parentName:"tr",align:null},"Web traffic load balancer")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Public IP"),(0,o.kt)("td",{parentName:"tr",align:null},"IP address associated with the Application Gateway")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Subnet - k8s"),(0,o.kt)("td",{parentName:"tr",align:null},"Subnet used by the AKS cluster")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"AKS"),(0,o.kt)("td",{parentName:"tr",align:null},"Azure Kubernetes Service")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Resource Group: Node Pool"),(0,o.kt)("td",{parentName:"tr",align:null},"AKS created resource group for nodes, load balancers, etc.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Internal Load Balancer"),(0,o.kt)("td",{parentName:"tr",align:null},"Load balancer used with NGINX ingress")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"VM Scale Set: Nodes"),(0,o.kt)("td",{parentName:"tr",align:null},"Virtual Machine scaling for AKS")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"NGINX Ingress"),(0,o.kt)("td",{parentName:"tr",align:null},"Nginx ingress Kubernetes namespace, deployment and service")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Internal DNS Zone"),(0,o.kt)("td",{parentName:"tr",align:null},"Custom DNS domain")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Public DNS Zone"),(0,o.kt)("td",{parentName:"tr",align:null},"Hosted service for DNS domain")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Application Insights"),(0,o.kt)("td",{parentName:"tr",align:null},"Application performance management, monitoring and analytics service")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Log Analytics Workspace"),(0,o.kt)("td",{parentName:"tr",align:null},"Log analytics with container insights")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Managed Identity"),(0,o.kt)("td",{parentName:"tr",align:null},"Managed Identity with aadpodidentity binding")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"ACR"),(0,o.kt)("td",{parentName:"tr",align:null},"Azure Container Registry")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Key Vault"),(0,o.kt)("td",{parentName:"tr",align:null},"Cryptographic keys and secrets management service")))),(0,o.kt)("h2",{id:"deploying"},"Deploying"),(0,o.kt)("h3",{id:"bootstrap-the-azure-tenant"},"Bootstrap the Azure tenant"),(0,o.kt)("p",null,"The first step is to create the Azure tenant and subscription. This process only needs to be run once on an administrators workstation."),(0,o.kt)("p",null,"The administrator will need the following permissions:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},'Azure AD "Global Administrator" role for the Azure AD Tenant'),(0,o.kt)("li",{parentName:"ul"},"IAM subscription owner")),(0,o.kt)("p",null,"With owner privileges:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create an ",(0,o.kt)("a",{parentName:"li",href:"https://www.terraform.io/docs/providers/azurerm/guides/service_principal_client_secret.html"},"Azure Service Principal")," for use with Terraform.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Make note of the TenantID, SubscriptionID, ClientID and ClientSecret"))),(0,o.kt)("li",{parentName:"ol"},"Create a ",(0,o.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/storage/common/storage-account-create"},"Blob Storage instance")," and ",(0,o.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/cli/azure/storage/container?view=azure-cli-latest#az_storage_container_create"},"container")," for storing Terraform state.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Take note of the storage account and container name.")))),(0,o.kt)("h3",{id:"using-the-scaffolding-cli"},"Using the Scaffolding CLI"),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@amidostacks/scaffolding-cli"},"Ensono Stacks Scaffolding CLI")," can be used to create a project consisting of the core infrastructure as code scripts and the deployment pipeline."),(0,o.kt)("p",null,"We are supporting and running ",(0,o.kt)("a",{parentName:"p",href:"https://nodejs.org/en/about/releases/"},"node@12"),".\nPlease ensure that your local environment has the correct version ",(0,o.kt)("a",{parentName:"p",href:"https://nodejs.org/en/download/"},"installed"),"."),(0,o.kt)("p",null,"To run the Scaffolding CLI, use the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx @amidostacks/scaffolding-cli@latest run -i\n")),(0,o.kt)("p",null,"You will be asked a number of questions. Make sure to select ",(0,o.kt)("inlineCode",{parentName:"p"},"Azure")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Cloud platform shared services"),"."),(0,o.kt)("h3",{id:"pipelines"},"Pipelines"),(0,o.kt)("p",null,"The following pipelines are currently supported for automating the deployment:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/infrastructure/azure/pipelines/azure_devops"},"Azure DevOps"))),(0,o.kt)("h3",{id:"running-locally"},"Running Locally"),(0,o.kt)("p",null,"Currently, vars.tf and provider configuration is not\nautomatically updated. Future iterations will include this."),(0,o.kt)("p",null,"The safest way to run and maintain this locally is to rely on Docker and environment\nvariables as that is the way the pipeline will trigger the\nexecutions of Terraform."),(0,o.kt)("p",null,"Sample commands with example environment vars:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'# Navigate to the infra directory\ncd ${YOUR_DIRECTORY_PATH}/deploy/azure/infra\n\n# Run Ensono Terraform Docker container\ndocker run -v $(pwd):/usr/data --rm -it amidostacks/ci-tf:0.0.4 /bin/bash\n\n###########################################################################\n# All commands from this point should be executed in the Docker container #\n###########################################################################\n\n# Navigate to /usr/data directory\ncd /usr/data\n\n# Export Azure Credentials. Replace the example values.\nexport ARM_CLIENT_ID=1111-2222-3333-444 \\\nARM_CLIENT_SECRET=1111-2222-3333-4444 \\\nARM_SUBSCRIPTION_ID=1111-2222-3333-444 \\\nARM_TENANT_ID=1111-2222-3333-444\n\n# Export Terraform variables. Replace the example values.\nexport TF_VAR_resource_group_location=uksouth \\\nTF_VAR_name_company=ensono \\\nTF_VAR_name_project=example \\\nTF_VAR_name_component=core \\\nTF_VAR_name_environment=nonprod \\\nTF_VAR_create_acr=true \\\nTF_VAR_acme_email=example@ensonostacks.com \\\nTF_VAR_is_cluster_private=true \\\nTF_VAR_cluster_version=1.17.11 \\\nTF_VAR_stage=nonprod \\\nTF_VAR_key_vault_name=example-core-nonprod \\\nTF_VAR_dns_zone=nonprod.ensonostacks.com \\\nTF_VAR_internal_dns_zone=nonprod.ensonostacks.internal\n\n# Initial Terraform. Replace the example values.\nterraform init \\\n-backend-config="resource_group_name=amido-stacks-terraform" \\\n-backend-config="storage_account_name=amidostacksterraform" \\\n-backend-config="container_name=tfstate" \\\n-backend-config="key=example-core"\n\n# Select or create the "nonprod" workspace.\nterraform workspace select nonprod || terraform workspace new nonprod\n\n# Check the plan matches your expected changes. \nterraform plan\n')),(0,o.kt)(i.Z,{prev:!0,mdxType:"HideNavigation"}))}g.isMDXComponent=!0}}]);