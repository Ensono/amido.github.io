"use strict";(self.webpackChunkstacks=self.webpackChunkstacks||[]).push([[6907],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return m}});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},g=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(t),g=i,m=u["".concat(l,".").concat(g)]||u[g]||d[g]||r;return t?a.createElement(m,o(o({ref:n},c),{},{components:t})):a.createElement(m,o({ref:n},c))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=g;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[u]="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}g.displayName="MDXCreateElement"},7718:function(e,n,t){t.r(n),t.d(n,{assets:function(){return c},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return u}});var a=t(7462),i=t(3366),r=(t(7294),t(3905)),o=["components"],s={id:"structure_java_cqrs",title:"Java Rest API Structure",sidebar_label:"Project structure",description:"Java Rest API Structure",keywords:["java","rest","api","project","overview","configuration","logging","application insights","swagger","authorisation","settings","cqrs"]},l=void 0,p={unversionedId:"workloads/common/backend/java/architecture/java_cqrs/structure_java_cqrs",id:"workloads/common/backend/java/architecture/java_cqrs/structure_java_cqrs",title:"Java Rest API Structure",description:"Java Rest API Structure",source:"@site/docs/workloads/common/backend/java/architecture/java_cqrs/structure_java_cqrs.md",sourceDirName:"workloads/common/backend/java/architecture/java_cqrs",slug:"/workloads/common/backend/java/architecture/java_cqrs/structure_java_cqrs",permalink:"/docs/workloads/common/backend/java/architecture/java_cqrs/structure_java_cqrs",draft:!1,tags:[],version:"current",frontMatter:{id:"structure_java_cqrs",title:"Java Rest API Structure",sidebar_label:"Project structure",description:"Java Rest API Structure",keywords:["java","rest","api","project","overview","configuration","logging","application insights","swagger","authorisation","settings","cqrs"]},sidebar:"docs",previous:{title:"Architecture overview",permalink:"/docs/workloads/common/backend/java/architecture/java_cqrs/architecture_java_cqrs"},next:{title:"Ensono Stacks with Nx",permalink:"/docs/nx/nx_stacks"}},c={},u=[{value:"Project structure",id:"project-structure",level:2},{value:"Overview of <code>com.amido.stacks.workflows.menu</code> packages",id:"overview-of-comamidostacksworkflowsmenu-packages",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Application logging",id:"application-logging",level:2},{value:"Application Insights",id:"application-insights",level:2},{value:"Authorization with Auth0",id:"authorization-with-auth0",level:2},{value:"Testing Auth0 JWT security using Swagger UI",id:"testing-auth0-jwt-security-using-swagger-ui",level:3}],d={toc:u},g="wrapper";function m(e){var n=e.components,t=(0,i.Z)(e,o);return(0,r.kt)(g,(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"project-structure"},"Project structure"),(0,r.kt)("p",null,"The outline structure of the project is as below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"\u251c\u2500\u2500 java\n\u2502   \u2514\u2500\u2500 com\n\u2502       \u2514\u2500\u2500 amido\n\u2502           \u2514\u2500\u2500 stacks\n\u2502               \u2514\u2500\u2500 workloads\n\u2502                   \u2514\u2500\u2500 menu\n\u2502                       \u251c\u2500\u2500 api\n\u2502                       \u2502   \u251c\u2500\u2500 v1\n\u2502                       \u2502   \u2502   \u251c\u2500\u2500 dto\n\u2502                       \u2502   \u2502   \u2502   \u251c\u2500\u2500 request\n\u2502                       \u2502   \u2502   \u2502   \u2514\u2500\u2500 response\n\u2502                       \u2502   \u2502   \u2514\u2500\u2500 impl\n\u2502                       \u2502   \u2514\u2500\u2500 v2\n\u2502                       \u2502       \u2514\u2500\u2500 impl\n\u2502                       \u251c\u2500\u2500 commands\n\u2502                       \u251c\u2500\u2500 domain\n\u2502                       \u251c\u2500\u2500 events\n\u2502                       \u251c\u2500\u2500 exception\n\u2502                       \u251c\u2500\u2500 handlers\n\u2502                       \u251c\u2500\u2500 mappers\n\u2502                       \u251c\u2500\u2500 repository\n\u2502                       \u2514\u2500\u2500 service\n\u2502                           \u2514\u2500\u2500 impl\n\u2514\u2500\u2500 resources\n    \u2514\u2500\u2500 local\n")),(0,r.kt)("h2",{id:"overview-of-comamidostacksworkflowsmenu-packages"},"Overview of ",(0,r.kt)("inlineCode",{parentName:"h2"},"com.amido.stacks.workflows.menu")," packages"),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.api.v1")," contains the ",(0,r.kt)("inlineCode",{parentName:"p"},"Controller")," definitions, both as interface definitions where the\n",(0,r.kt)("a",{parentName:"p",href:"https://swagger.io/"},"Swagger")," (OpenAPI) details are defined, and as concrete implementations under the ",(0,r.kt)("inlineCode",{parentName:"p"},"impl")," package."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.api.v1.dto")," contains request and response object definitions for the different endpoints."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.api")," additionally contains the ",(0,r.kt)("inlineCode",{parentName:"p"},"OpenApiConfiguration")," class, which is responsible for\ndefining what is displayed by the Swagger UI page for the application."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.commands")," contains the ",(0,r.kt)("inlineCode",{parentName:"p"},"Command")," classes specific to particular API update operations, e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"CreateMenuCommand"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"DeleteItemCommand")," etc."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.domain")," contains the data object defintions for the Menu model: ",(0,r.kt)("inlineCode",{parentName:"p"},"Menu"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Category")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Item"),"."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.events")," contains the ",(0,r.kt)("inlineCode",{parentName:"p"},"Event")," definitions for specific API update events."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.exception")," contains the custom ",(0,r.kt)("inlineCode",{parentName:"p"},"Exception")," definitions for the application."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.handlers")," contains the ",(0,r.kt)("inlineCode",{parentName:"p"},"Handler")," definitions that coordinate command execution and the sending of events."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.repository")," contains the ",(0,r.kt)("inlineCode",{parentName:"p"},"MenuRepository")," interface definition, which defines repository operations and\nextends ",(0,r.kt)("inlineCode",{parentName:"p"},"CosmosRepository"),", itself an extension of the Spring ",(0,r.kt)("inlineCode",{parentName:"p"},"PagingAndSortingRepository"),"."),(0,r.kt)("p",null,"Package ",(0,r.kt)("inlineCode",{parentName:"p"},"menu.service")," contains the interface ",(0,r.kt)("inlineCode",{parentName:"p"},"MenuQueryService")," and its implementation, ",(0,r.kt)("inlineCode",{parentName:"p"},"CosmosMenuQueryService")," which relies\non the CosmosRepository to fulfil the service's actions."),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"resources")," directory contains an ",(0,r.kt)("inlineCode",{parentName:"p"},"application.yaml")," file, and this is responsible for the project configuration.\nThis information includes Azure Cosmos DB and Application Insights configuration, which are passed as a environment variables during the deployment phase."),(0,r.kt)("p",null,"Below is snippet of the ",(0,r.kt)("inlineCode",{parentName:"p"},"application.yml")," configuring the Swagger and the Spring Boot specifications:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"spring:\n  application:\n    name: xxSTACKSxx-api\n  data:\n    rest:\n      detection-strategy: annotated\n\nserver:\n  # Note: ONLY use this if you're behind a trusted Reverse Proxy, such as Application Gateway.\n  # If you host this app directly then users can easily inject headers.\n  forward-headers-strategy: framework\n  #######\n  port: 9000\n\nmanagement:\n  endpoints:\n    web:\n      base-path: /\n\nspringdoc:\n  swagger-ui:\n    disable-swagger-default-url: true\n    display-operation-id: true\n    path: /swagger/index.html\n  packagesToScan: com.xxENSONOxx.xxSTACKSxx.menu.api\n  api-docs:\n    groups:\n      enabled: true\n    enabled: true\n    path: /swagger/oas-json\n")),(0,r.kt)("h2",{id:"application-logging"},"Application logging"),(0,r.kt)("p",null,"Java provides a simple logging abstraction with most of required logging features used by an application.\nWhenever logging is required in the application, the class will instantiate an instance of Logger from slf4j to use as the logger object. The Logger instances are created by Logging Factory registered by each application and will abstract the logging library from the application logging."),(0,r.kt)("p",null,"In the application, we have customized how the logs are created. There is a ",(0,r.kt)("inlineCode",{parentName:"p"},"logback-spring.xml")," file in the ",(0,r.kt)("inlineCode",{parentName:"p"},"resources")," directory\nto add the customized features, as below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<?xml version="1.0" encoding="UTF-8"?>\n<configuration>\n  <appender class="ch.qos.logback.core.ConsoleAppender" name="console">\n    <encoder>\n      <pattern>%d{dd-MM-yyyy HH:mm:ss.SSS} %magenta([%thread]) | %X{CorrelationId} |\n        %highlight(%-5level) %logger{36}.%M - %msg%n\n      </pattern>\n    </encoder>\n  </appender>\n  <appender class="com.microsoft.applicationinsights.logback.ApplicationInsightsAppender"\n    name="aiAppender">\n  </appender>\n  <root level="debug">\n    <appender-ref ref="console"/>\n  </root>\n  <root level="info">\n    <appender-ref ref="aiAppender"/>\n  </root>\n</configuration>\n\n')),(0,r.kt)("h2",{id:"application-insights"},"Application Insights"),(0,r.kt)("p",null,"Azure Application Insights is the chosen logging platform, and will aggregate all logs generated by all services."),(0,r.kt)("p",null,"Integrating with Application Insights ensures all logs generated (and filtered) are forwarded to the logging platform\nfor correlation and potential future investigation. Below is the section that needs to be added the ",(0,r.kt)("inlineCode",{parentName:"p"},"application.yml")," to\nenable it to interact with Application Insights:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"}," application-insights:\n    instrumentation-key: xxxxxx\n    enabled: true\n")),(0,r.kt)("p",null,"Additionally, an ",(0,r.kt)("inlineCode",{parentName:"p"},"AI-Agent.xml")," definition is included in the ",(0,r.kt)("inlineCode",{parentName:"p"},"resource")," directory to enable deeper data insights:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<?xml version="1.0" encoding="utf-8"?>\n<ApplicationInsightsAgent>\n  <Instrumentation>\n    <BuiltIn>\n      <Logging threshold="info"/>\n    </BuiltIn>\n  </Instrumentation>\n</ApplicationInsightsAgent>\n')),(0,r.kt)("p",null,"Any events published by the application will have a correlation id, to enable tracking of requests, responses and any exceptions."),(0,r.kt)("h2",{id:"authorization-with-auth0"},"Authorization with Auth0"),(0,r.kt)("p",null,"The API endpoints are protected by an OAuth 2.0 provider.\nThe OAuth 2.0 client is configured as an ",(0,r.kt)("a",{parentName:"p",href:"https://auth0.com/"},"Auth0")," instance. All requests must include a ",(0,r.kt)("inlineCode",{parentName:"p"},"Bearer")," token in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," header."),(0,r.kt)("p",null,"There is an ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.properties")," file which configures the authorization definitions required to use\nthe application with in conjunction with Auth0 to secure access to endpoints with JWT. If this property is set:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"auth.isEnabled=true\n")),(0,r.kt)("p",null,"then a valid JWT is required to be sent with the header in the request to the API endpoint."),(0,r.kt)("p",null,"Other Auth0 properties defined in this file, and used by spring security for validating the token are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"auth0.issuer")," - the issuer of the JWT Token. Typically, this is your Auth0 domain prefixed by ",(0,r.kt)("inlineCode",{parentName:"li"},"https://")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"auth0.apiAudience")," - the unique identifier for your API, ",(0,r.kt)("inlineCode",{parentName:"li"},"https://.../api/v2/"))),(0,r.kt)("h3",{id:"testing-auth0-jwt-security-using-swagger-ui"},"Testing Auth0 JWT security using Swagger UI"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Open the swagger UI page at ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9000/swagger/index.html"},"http://localhost:9000/swagger/index.html")," once\nthe application is up and running locally.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Send a POST request via the ",(0,r.kt)("inlineCode",{parentName:"p"},"Auth")," endpoint on the Swagger UI page for your configured API definition, containing the following payload:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "client_id": "REDACTED",\n  "client_secret": "REDACTED",\n  "audience": "https://REDACTED/api/v2/",\n  "grant_type": "client_credentials"\n}\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"You should receive a response containing a valid token something like"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhbGciOiJSU...wd6WXw",\n    "expires_in": 86400,\n    "token_type": "Bearer"\n}\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Click on the ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorise")," button on the Swagger UI page and paste the token.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Endpoints should now work ",(0,r.kt)("em",{parentName:"p"},"only")," with a valid token."))))}m.isMDXComponent=!0}}]);