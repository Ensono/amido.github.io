"use strict";(self.webpackChunkstacks=self.webpackChunkstacks||[]).push([[4976],{3646:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>d,toc:()=>l});var r=t(4848),s=t(8453);const a={},i=void 0,d={id:"getting_started/next/next-auth-redis-deployment",title:"next-auth-redis-deployment",description:"@ensono-stacks/next:next-auth-redis-deployment",source:"@site/docs/getting_started/next/next-auth-redis-deployment.md",sourceDirName:"getting_started/next",slug:"/getting_started/next/next-auth-redis-deployment",permalink:"/docs/getting_started/next/next-auth-redis-deployment",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{}},o={},l=[{value:"@ensono-stacks/next",id:"ensono-stacksnext",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Usage",id:"usage",level:2},{value:"Command line arguments",id:"command-line-arguments",level:3},{value:"Generator Output",id:"generator-output",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h3,{id:"ensono-stacksnext",children:["@ensono-stacks/next",":next-auth-redis-deployment"]}),"\n",(0,r.jsxs)(t,{children:[(0,r.jsx)("summary",{children:"Configure Deployment & Infra to support Redis in your Next application"}),(0,r.jsx)(n.p,{children:"The next-auth-redis-deployment generator will add required Redis config into your existing Next app with Next-auth."}),(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),(0,r.jsxs)(n.p,{children:["An existing ",(0,r.jsx)(n.a,{href:"https://nextjs.org/",children:"Next"})," application with Next-auth. Use the ",(0,r.jsx)(n.code,{children:"@ensono-stacks/next:next-auth"})," generator to add this into your application"]}),(0,r.jsx)(n.h2,{id:"usage",children:"Usage"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nx g @ensono-stacks/next:next-auth-redis-deployment\n"})}),(0,r.jsx)(n.h3,{id:"command-line-arguments",children:"Command line arguments"}),(0,r.jsx)(n.p,{children:"The following command line arguments are available:"}),(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Accepted Values"}),(0,r.jsx)(n.th,{children:"Default"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"--project"}),(0,r.jsx)(n.td,{children:"The name of the project"}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"N/A"})]})})]}),(0,r.jsx)(n.h3,{id:"generator-output",children:"Generator Output"}),(0,r.jsx)(n.p,{children:"When infrastructure is detected for the application, these files will be enhanced to cater for Redis:"}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'"app-name"/build/values[-prod].yaml files will have 3 new entries added for redis'}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'redisURL: ""\nnextAuthSecret: ""\nnextAuthURL: <app-name>.<internal/external domain>\n'})}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'"app-name"/terraform/main.tf will have a new azurerm_redis_cache resource added. The variables.tf file will have these corresponding variables defined'}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'resource "azurerm_redis_cache" "default_primary" {\n  name                = var.redis_name\n  location            = var.redis_resource_group_location\n  resource_group_name = var.redis_resource_group_name\n  capacity            = var.redis_capacity\n  family              = var.redis_family\n  sku_name            = var.redis_sku_name\n  minimum_tls_version = var.minimum_tls_version\n}\n'})}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'"app-name"/terraform/[prod/nonprod].tfvars will have additional variables added.'}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'redis_name =\n  "<company>-<domain>-<prod/nonprod>-<cloud region>-<business component>";\nredis_resource_group_location = "%REPLACE%";\nredis_resource_group_name =\n  "<company>-<domain>-<prod/nonprod>-<cloud region>-<business component>";\n'})}),(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"Be sure to update the redis_resource_group_location value"})}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'"app-name"/terraform/outputs.tf will have the redis_connection_string added'}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'output "redis_connection_string" {\n  sensitive = true\n  value     = "rediss://:${azurerm_redis_cache.default_primary.primary_access_key}@${azurerm_redis_cache.default_primary.hostname}:${azurerm_redis_cache.default_primary.ssl_port}"\n}\n'})}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'"app-name"/.env.local will have the REDIS_URL env variable added and set'}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"REDIS_URL=localhost:6379\n"})}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'"app-name"/project.json will have the helm-upgrade commands updated to use the NEXTAUTH_SECRET'}),"\n"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'"helm-upgrade": {\n      "executor": "nx:run-commands",\n      "options": {\n        "commands": [\n          {\n            "command": "helm upgrade [... unchanged ...] --set nextAuthSecret=\\\\\\"$NEXTAUTH_SECRET\\\\\\"",\n            "forwardAllArgs": false\n          }\n        ],\n        "cwd": "apps/baseline-next-app/build/terraform"\n      },\n      "configurations": {\n        "prod": {\n          "commands": [\n            {\n              "command": "helm upgrade [... unchanged ...] --set nextAuthSecret=\\\\\\"$NEXTAUTH_SECRET\\\\\\"",\n              "forwardAllArgs": false\n            }\n          ]\n        }\n      }\n'})}),(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["For Azure DevOps, the ",(0,r.jsx)(n.strong,{children:"NEXTAUTH_SECRET"})," needs to be added to the ",(0,r.jsx)(n.code,{children:"<company\\>-<component\\>-<domain\\>-nonprod"})," and ",(0,r.jsx)(n.code,{children:"<company\\>-<component\\>-<domain\\>-prod"}),"' variable groups"]})})]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>d});var r=t(6540);const s={},a=r.createContext(s);function i(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);