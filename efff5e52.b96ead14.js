(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{152:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return c})),t.d(n,"rightToc",(function(){return s})),t.d(n,"default",(function(){return l}));var a=t(2),i=t(6),r=(t(0),t(171)),o={id:"structure_java_cqrs",title:"Java Rest API Structure",sidebar_label:"Project structure"},c={unversionedId:"workloads/azure/backend/java_cqrs/structure_java_cqrs",id:"workloads/azure/backend/java_cqrs/structure_java_cqrs",isDocsHomePage:!1,title:"Java Rest API Structure",description:"Project structure",source:"@site/docs/workloads/azure/backend/java_cqrs/structure_java_cqrs.md",slug:"/workloads/azure/backend/java_cqrs/structure_java_cqrs",permalink:"/stacks/docs/workloads/azure/backend/java_cqrs/structure_java_cqrs",version:"current",sidebar_label:"Project structure",sidebar:"docs",previous:{title:"Java Rest API Architecture",permalink:"/stacks/docs/workloads/azure/backend/java_cqrs/architecture_java_cqrs"},next:{title:"Java REST API with CQRS - Azure Infrastructure",permalink:"/stacks/docs/workloads/azure/backend/java_cqrs/infrastructure_java_cqrs"}},s=[{value:"Project structure",id:"project-structure",children:[]},{value:"Overview of <code>com.xxAMIDOxx.xxSTACKSxx.core</code> packages",id:"overview-of-comxxamidoxxxxstacksxxcore-packages",children:[]},{value:"Overview of <code>com.xxAMIDOxx.xxSTACKSxx.menu</code> packages",id:"overview-of-comxxamidoxxxxstacksxxmenu-packages",children:[]},{value:"Configuration",id:"configuration",children:[]},{value:"Application logging",id:"application-logging",children:[]},{value:"Application Insights",id:"application-insights",children:[]},{value:"Authorization with Auth0",id:"authorization-with-auth0",children:[{value:"Testing Auth0 JWT security using Swagger UI",id:"testing-auth0-jwt-security-using-swagger-ui",children:[]}]}],p={rightToc:s};function l(e){var n=e.components,t=Object(i.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},p,t,{components:n,mdxType:"MDXLayout"}),Object(r.b)("h2",{id:"project-structure"},"Project structure"),Object(r.b)("p",null,"The outline structure of the project is as below."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"\u251c\u2500\u2500 java\n\u2502\xa0\xa0 \u2514\u2500\u2500 com\n\u2502\xa0\xa0     \u2514\u2500\u2500 xxAMIDOxx\n\u2502\xa0\xa0         \u2514\u2500\u2500 xxSTACKSxx\n\u2502\xa0\xa0             \u251c\u2500\u2500 core\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 dto\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 exception\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 filter\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u251c\u2500\u2500 azure\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 servicebus\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u251c\u2500\u2500 cqrs\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 command\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 handler\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u251c\u2500\u2500 messaging\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 event\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 publish\n\u2502\xa0\xa0             \u2502\xa0\xa0 \u2514\u2500\u2500 operations\n\u2502\xa0\xa0             \u2514\u2500\u2500 menu\n\u2502\xa0\xa0                 \u251c\u2500\u2500 api\n\u2502\xa0\xa0                 \u2502\xa0\xa0 \u251c\u2500\u2500 v1\n\u2502\xa0\xa0                 \u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 dto\n\u2502\xa0\xa0                 \u2502\xa0\xa0 \u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 request\n\u2502\xa0\xa0                 \u2502\xa0\xa0 \u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 response\n\u2502\xa0\xa0                 \u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 impl\n\u2502\xa0\xa0                 \u2502\xa0\xa0 \u2514\u2500\u2500 v2\n\u2502\xa0\xa0                 \u2502\xa0\xa0     \u2514\u2500\u2500 impl\n\u2502\xa0\xa0                 \u251c\u2500\u2500 commands\n\u2502\xa0\xa0                 \u251c\u2500\u2500 domain\n\u2502\xa0\xa0                 \u251c\u2500\u2500 events\n\u2502\xa0\xa0                 \u251c\u2500\u2500 exception\n\u2502\xa0\xa0                 \u251c\u2500\u2500 handlers\n\u2502\xa0\xa0                 \u251c\u2500\u2500 mappers\n\u2502\xa0\xa0                 \u251c\u2500\u2500 repository\n\u2502\xa0\xa0                 \u2514\u2500\u2500 service\n\u2502\xa0\xa0                     \u2514\u2500\u2500 impl\n\u2514\u2500\u2500 resources\n")),Object(r.b)("h2",{id:"overview-of-comxxamidoxxxxstacksxxcore-packages"},"Overview of ",Object(r.b)("inlineCode",{parentName:"h2"},"com.xxAMIDOxx.xxSTACKSxx.core")," packages"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"core.api")," package contains the request filter definitions (responsible for generating a\ncorrelation ID for every request), and the main Exception\nclass from which all other custom exceptions in the code extend."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"core.azure.servicebus")," package contains definitions to sent messages to the Azure service bus, if configured. It is disabled by default."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"core.cqrs")," package contains the basic ",Object(r.b)("inlineCode",{parentName:"p"},"Command")," and ",Object(r.b)("inlineCode",{parentName:"p"},"CommandHandler")," definitions that individual commands extend."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"core.messaging")," contains the ",Object(r.b)("inlineCode",{parentName:"p"},"ApplicationEvent")," definition and default event publisher (used when servicebus is disable in configuration)."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"core.operations")," contains the abstract ",Object(r.b)("inlineCode",{parentName:"p"},"OperationContext")," class that stores operation code and correlation ID."),Object(r.b)("h2",{id:"overview-of-comxxamidoxxxxstacksxxmenu-packages"},"Overview of ",Object(r.b)("inlineCode",{parentName:"h2"},"com.xxAMIDOxx.xxSTACKSxx.menu")," packages"),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.api.v1")," contains the ",Object(r.b)("inlineCode",{parentName:"p"},"Controller")," definitions, both as interface definitions where the\n",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://swagger.io/"}),"Swagger")," (OpenAPI) details are defined, and as concrete implementations under the ",Object(r.b)("inlineCode",{parentName:"p"},"impl")," package."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.api.v1.dto")," contains request and response object definitions for the different endpoints."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.api")," additionally contains the ",Object(r.b)("inlineCode",{parentName:"p"},"OpenApiConfiguration")," class, which is responsible for\ndefining what is displayed by the Swagger UI page for the application."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.commands")," contains the ",Object(r.b)("inlineCode",{parentName:"p"},"Command")," classes specific to particular API update operations, e.g. ",Object(r.b)("inlineCode",{parentName:"p"},"CreateMenuCommand"),", ",Object(r.b)("inlineCode",{parentName:"p"},"DeleteItemCommand")," etc."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.domain")," contains the data object defintions for the Menu model: ",Object(r.b)("inlineCode",{parentName:"p"},"Menu"),", ",Object(r.b)("inlineCode",{parentName:"p"},"Category")," and ",Object(r.b)("inlineCode",{parentName:"p"},"Item"),"."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.events")," contains the ",Object(r.b)("inlineCode",{parentName:"p"},"Event")," definitions for specific API update events."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.exception")," contains the custom ",Object(r.b)("inlineCode",{parentName:"p"},"Exception")," definitions for the application."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.handlers")," contains the ",Object(r.b)("inlineCode",{parentName:"p"},"Handler")," definitions that coordinate command execution and the sending of events."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.repository")," contains the ",Object(r.b)("inlineCode",{parentName:"p"},"MenuRepository")," interface definition, which defines repository operations and\nextends ",Object(r.b)("inlineCode",{parentName:"p"},"CosmosRepository"),", itself an extension of the Spring ",Object(r.b)("inlineCode",{parentName:"p"},"PagingAndSortingRepository"),"."),Object(r.b)("p",null,"Package ",Object(r.b)("inlineCode",{parentName:"p"},"menu.service")," contains the interface ",Object(r.b)("inlineCode",{parentName:"p"},"MenuQueryService")," and its implementation, ",Object(r.b)("inlineCode",{parentName:"p"},"CosmosMenuQueryService")," which relies\non the CosmosRepository to fulfil the service's actions."),Object(r.b)("h2",{id:"configuration"},"Configuration"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"resources")," directory contains an ",Object(r.b)("inlineCode",{parentName:"p"},"application.yaml")," file, and this is responsible for the project configuration.\nThis information includes Azure Cosmos DB and Application Insights configuration, which are passed as a environment variables during the deployment phase."),Object(r.b)("p",null,"Below is snippet of the ",Object(r.b)("inlineCode",{parentName:"p"},"application.yml")," configuring the Swagger and the Spring Boot specifications:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"spring:\n  application:\n    name: xxSTACKSxx-api\n  data:\n    rest:\n      detection-strategy: annotated\n\nserver:\n  # Note: ONLY use this if you're behind a trusted Reverse Proxy, such as Application Gateway.\n  # If you host this app directly then users can easily inject headers.\n  forward-headers-strategy: framework\n  #######\n  port: 9000\n\nmanagement:\n  endpoints:\n    web:\n      base-path: /\n\nspringdoc:\n  swagger-ui:\n    disable-swagger-default-url: true\n    display-operation-id: true\n    path: /swagger/index.html\n  packagesToScan: com.xxAMIDOxx.xxSTACKSxx.menu.api\n  api-docs:\n    groups:\n      enabled: true\n    enabled: true\n    path: /swagger/oas-json\n")),Object(r.b)("h2",{id:"application-logging"},"Application logging"),Object(r.b)("p",null,"Java provides a simple logging abstraction with most of required logging features used by an application.\nWhenever logging is required in the application, the class will instantiate an instance of Logger from slf4j to use as the logger object. The Logger instances are created by Logging Factory registered by each application and will abstract the logging library from the application logging."),Object(r.b)("p",null,"In the application, we have customized how the logs are created. There is a ",Object(r.b)("inlineCode",{parentName:"p"},"logback-spring.xml")," file in the ",Object(r.b)("inlineCode",{parentName:"p"},"resources")," directory\nto add the customized features, as below:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-xml"}),'<?xml version="1.0" encoding="UTF-8"?>\n<configuration>\n  <appender class="ch.qos.logback.core.ConsoleAppender" name="console">\n    <encoder>\n      <pattern>%d{dd-MM-yyyy HH:mm:ss.SSS} %magenta([%thread]) | %X{CorrelationId} |\n        %highlight(%-5level) %logger{36}.%M - %msg%n\n      </pattern>\n    </encoder>\n  </appender>\n  <appender class="com.microsoft.applicationinsights.logback.ApplicationInsightsAppender"\n    name="aiAppender">\n  </appender>\n  <root level="debug">\n    <appender-ref ref="console"/>\n  </root>\n  <root level="info">\n    <appender-ref ref="aiAppender"/>\n  </root>\n</configuration>\n\n')),Object(r.b)("h2",{id:"application-insights"},"Application Insights"),Object(r.b)("p",null,"Azure Application Insights is the chosen logging platform, and will aggregate all logs generated by all services."),Object(r.b)("p",null,"Integrating with Application Insights ensures all logs generated (and filtered) are forwarded to the logging platform\nfor correlation and potential future investigation. Below is the section that needs to be added the ",Object(r.b)("inlineCode",{parentName:"p"},"application.yml")," to\nenable it to interact with Application Insights:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"})," application-insights:\n    instrumentation-key: xxxxxx\n    enabled: true\n")),Object(r.b)("p",null,"We also need to add the SDK dependencies to the ",Object(r.b)("inlineCode",{parentName:"p"},"pom.xml")," file definitions:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-xml"}),"<dependency>\n    <groupId>com.microsoft.azure</groupId>\n    <artifactId>applicationinsights-spring-boot-starter</artifactId>\n    <version>${applicationinsights.version}</version>\n    <scope>runtime</scope>\n</dependency>\n\n<dependency>\n    <groupId>com.microsoft.azure</groupId>\n    <artifactId>applicationinsights-logging-logback</artifactId>\n    <version>${applicationinsights.version}</version>\n    <scope>runtime</scope>\n</dependency>\n")),Object(r.b)("p",null,"Additionally, an ",Object(r.b)("inlineCode",{parentName:"p"},"AI-Agent.xml")," definition is included in the ",Object(r.b)("inlineCode",{parentName:"p"},"resource")," directory to enable deeper data insights:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-xml"}),'<?xml version="1.0" encoding="utf-8"?>\n<ApplicationInsightsAgent>\n  <Instrumentation>\n    <BuiltIn>\n      <Logging threshold="info"/>\n    </BuiltIn>\n  </Instrumentation>\n</ApplicationInsightsAgent>\n')),Object(r.b)("p",null,"Any events published by the application will have a correlation id, to enable tracking of requests, responses and any exceptions."),Object(r.b)("h2",{id:"authorization-with-auth0"},"Authorization with Auth0"),Object(r.b)("p",null,"The API endpoints are protected by an OAuth 2.0 provider.\nThe OAuth 2.0 client is configured as an ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://auth0.com/"}),"Auth0")," instance. All requests must include a ",Object(r.b)("inlineCode",{parentName:"p"},"Bearer")," token in the ",Object(r.b)("inlineCode",{parentName:"p"},"Authorization")," header."),Object(r.b)("p",null,"There is an ",Object(r.b)("inlineCode",{parentName:"p"},"auth.properties")," file which configures the authorization definitions required to use\nthe application with in conjunction with Auth0 to secure access to endpoints with JWT. If this property is set:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-properties"}),"auth.isEnabled=true\n")),Object(r.b)("p",null,"then a valid JWT is required to be sent with the header in the request to the API endpoint."),Object(r.b)("p",null,"Other Auth0 properties defined in this file, and used by spring security for validating the token are:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"auth0.issuer")," - the issuer of the JWT Token. Typically, this is your Auth0 domain prefixed by ",Object(r.b)("inlineCode",{parentName:"li"},"https://")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"auth0.apiAudience")," - the unique identifier for your API, ",Object(r.b)("inlineCode",{parentName:"li"},"https://.../api/v2/"))),Object(r.b)("h3",{id:"testing-auth0-jwt-security-using-swagger-ui"},"Testing Auth0 JWT security using Swagger UI"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Open the swagger UI page at ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"http://localhost:9000/swagger/index.html"}),"http://localhost:9000/swagger/index.html")," once\nthe application is up and running locally.")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Send a POST request via the ",Object(r.b)("inlineCode",{parentName:"p"},"Auth")," endpoint on the Swagger UI page for your configured API definition, containing the following payload:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{\n  "client_id": "REDACTED",\n  "client_secret": "REDACTED",\n  "audience": "https://REDACTED/api/v2/",\n  "grant_type": "client_credentials"\n}\n'))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"You should receive a response containing a valid token something like"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{\n    "access_token": "eyJhbGciOiJSU...wd6WXw",\n    "expires_in": 86400,\n    "token_type": "Bearer"\n}\n'))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Click on the ",Object(r.b)("inlineCode",{parentName:"p"},"Authorise")," button on the Swagger UI page and paste the token.")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Endpoints should now work ",Object(r.b)("em",{parentName:"p"},"only")," with a valid token."))))}l.isMDXComponent=!0},171:function(e,n,t){"use strict";t.d(n,"a",(function(){return d})),t.d(n,"b",(function(){return g}));var a=t(0),i=t.n(a);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var p=i.a.createContext({}),l=function(e){var n=i.a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):c(c({},n),e)),t},d=function(e){var n=l(e.components);return i.a.createElement(p.Provider,{value:n},e.children)},b={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},u=i.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=l(t),u=a,g=d["".concat(o,".").concat(u)]||d[u]||b[u]||r;return t?i.a.createElement(g,c(c({ref:n},p),{},{components:t})):i.a.createElement(g,c({ref:n},p))}));function g(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,o=new Array(r);o[0]=u;var c={};for(var s in n)hasOwnProperty.call(n,s)&&(c[s]=n[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var p=2;p<r;p++)o[p]=t[p];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,t)}u.displayName="MDXCreateElement"}}]);